<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceSentinel | Agent Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .risk-gauge {
            transition: width 0.5s ease-out;
        }
    </style>
</head>

<body class="bg-gray-900 text-white h-screen flex overflow-hidden">

    <!-- Sidebar: Active Sessions -->
    <aside class="w-80 bg-gray-800 border-r border-gray-700 flex flex-col">
        <div class="p-4 border-b border-gray-700 flex items-center gap-2">
            <i data-lucide="shield-alert" class="text-indigo-400"></i>
            <h1 class="text-xl font-bold tracking-tight">VoiceSentinel</h1>
        </div>

        <div class="p-2 overflow-y-auto flex-1" id="session-list">
            <!-- Session Items Injected Here -->
            <div class="text-gray-500 text-sm p-4 text-center">Waiting for calls...</div>
        </div>

        <div class="p-4 border-t border-gray-700 text-xs text-center text-gray-500">
            System Status: <span class="text-green-400">Online</span>
        </div>
    </aside>

    <!-- Main Content: Detailed Report -->
    <main class="flex-1 flex flex-col relative">
        <!-- Header -->
        <header class="h-16 bg-gray-800 border-b border-gray-700 flex items-center justify-between px-8">
            <div id="header-info">
                <h2 class="text-lg font-semibold text-gray-200">Session Analysis</h2>
                <p class="text-xs text-gray-400" id="header-sub">Select a session to view details</p>
            </div>
            <div class="flex items-center gap-4">
                <div class="px-3 py-1 bg-gray-700 rounded text-xs font-mono" id="connection-status">Connecting...</div>
            </div>
        </header>

        <!-- Report Content -->
        <div id="report-container" class="flex-1 p-8 overflow-y-auto hidden">

            <!-- View: LIVE MODE (Transcript Only) -->
            <div id="view-live" class="flex-1 flex flex-col hidden">
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 flex flex-col flex-1">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-gray-400 text-sm font-medium uppercase tracking-wider flex items-center gap-2">
                            <i data-lucide="mic-2" class="w-4 h-4 text-green-400 animate-pulse"></i> Live Conversation
                        </h3>
                        <span class="text-xs bg-gray-700 px-2 py-1 rounded text-gray-300">Listening...</span>
                    </div>
                    <div id="transcript-box-live"
                        class="flex-1 bg-gray-900 rounded p-6 overflow-y-auto font-mono text-sm text-gray-300 leading-relaxed whitespace-pre-wrap">
                        Initializing...
                    </div>

                    <!-- 2-Way Controls -->
                    <div id="controls-area"
                        class="mt-4 border-t border-gray-700 pt-4 flex flex-col items-center hidden">
                        <p class="text-xs text-gray-500 mb-2 font-mono uppercase tracking-wider" id="mic-status">Hold
                            Spacebar or Click & Hold to Speak</p>
                        <button id="btn-mic"
                            class="w-16 h-16 rounded-full bg-indigo-600 shadow-lg flex items-center justify-center transition opacity-50 cursor-not-allowed"
                            onmousedown="startRecording()" onmouseup="stopRecording()" onmouseleave="stopRecording()"
                            ontouchstart="startRecording()" ontouchend="stopRecording()" disabled>
                            <i data-lucide="mic" class="w-8 h-8 text-white"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- View: REPORT MODE (Hidden initially) -->
            <div id="view-report" class="flex-1 flex flex-col hidden">
                <!-- Risk Score Hero -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- Main Score Card -->
                    <div
                        class="col-span-2 bg-gray-800 rounded-xl p-6 border border-gray-700 shadow-xl relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-10">
                            <i data-lucide="activity" class="w-32 h-32 text-indigo-500"></i>
                        </div>

                        <h3 class="text-gray-400 text-sm font-medium uppercase tracking-wider mb-2">Total Fraud Risk
                            Score
                        </h3>
                        <div class="flex items-end gap-4 mb-4">
                            <span class="text-6xl font-bold" id="risk-score-val">0</span>
                            <span class="text-2xl text-gray-400 mb-2">/ 100</span>
                            <span class="px-3 py-1 rounded text-sm font-bold mb-2 ml-auto"
                                id="risk-badge">CALCULATING</span>
                        </div>

                        <!-- Progress Bar -->
                        <div class="w-full bg-gray-700 h-4 rounded-full overflow-hidden">
                            <div id="risk-bar" class="h-full bg-green-500 risk-gauge" style="width: 0%"></div>
                        </div>
                        <p class="mt-4 text-sm text-gray-400" id="risk-desc">Waiting for sufficient data...</p>
                    </div>

                    <!-- Live Signal Grid -->
                    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                        <h3 class="text-gray-400 text-sm font-medium uppercase tracking-wider mb-4">Critical Signals
                        </h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="flex items-center gap-2"><i data-lucide="bot"
                                        class="w-4 h-4 text-gray-400"></i> AI Detection</span>
                                <span id="sig-ai" class="font-mono text-gray-500">--</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="flex items-center gap-2"><i data-lucide="mic"
                                        class="w-4 h-4 text-gray-400"></i> Voice Match</span>
                                <span id="sig-match" class="font-mono text-gray-500">--</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="flex items-center gap-2"><i data-lucide="clock"
                                        class="w-4 h-4 text-gray-400"></i> Latency</span>
                                <span id="sig-latency" class="font-mono text-gray-500">--</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="flex items-center gap-2"><i data-lucide="database"
                                        class="w-4 h-4 text-gray-400"></i> Identity</span>
                                <span id="sig-identity" class="font-mono text-gray-500">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- Related Accounts Grid -->
                    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                        <h3 class="text-gray-400 text-sm font-medium uppercase tracking-wider mb-4">Related / Authorized
                            Accounts</h3>
                        <div id="related-accounts-list"
                            class="space-y-2 text-sm text-gray-400 font-mono h-32 overflow-y-auto">
                            <!-- Populated via JS -->
                            <p class="italic text-gray-600">None found.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Analysis Sections -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Memory Section -->
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                <h3 class="text-gray-400 text-sm font-medium uppercase tracking-wider mb-4 flex items-center gap-2">
                    <i data-lucide="brain-circuit" class="w-4 h-4"></i> Cross-Call Memory
                </h3>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between p-3 bg-gray-700/50 rounded-lg">
                        <span>Name Stability</span>
                        <span id="mem-name" class="font-bold text-gray-300">--</span>
                    </div>
                    <div class="flex justify-between p-3 bg-gray-700/50 rounded-lg">
                        <span>DOB Consistency</span>
                        <span id="mem-dob" class="font-bold text-gray-300">--</span>
                    </div>
                    <div class="flex justify-between p-3 bg-gray-700/50 rounded-lg">
                        <span>Trust Trend</span>
                        <span id="mem-trust" class="font-bold text-gray-300">--</span>
                    </div>
                </div>
            </div>

            <!-- Final Transcript Preview -->
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 flex flex-col h-64">
                <h3 class="text-gray-400 text-sm font-medium uppercase tracking-wider mb-2 flex items-center gap-2">
                    <i data-lucide="scroll-text" class="w-4 h-4"></i> Session Transcript
                </h3>
                <div id="transcript-box-report"
                    class="flex-1 bg-gray-900 rounded p-4 overflow-y-auto font-mono text-xs text-gray-300 leading-relaxed">
                    --
                </div>
            </div>
        </div>

        <!-- Continue Action -->
        <div class="mt-8 pt-6 border-t border-gray-700 flex justify-between items-center">
            <p class="text-sm text-gray-400">Review the report above. Proceed with 2-way communication?</p>
            <button id="btn-continue"
                class="px-6 py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-bold shadow-lg flex items-center gap-2 transition"
                onclick="resumeConversation()">
                <i data-lucide="message-square-plus" class="w-5 h-5"></i> Continue Conversation
            </button>
        </div>
        </div>

        <!-- Action Bar -->
        <div class="mt-6 flex justify-end gap-4">
            <button class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm text-white font-medium transition"
                onclick="pollSession()">Force Refresh</button>
        </div>

        </div>

        <!-- Empty State -->
        <div id="empty-state" class="flex-1 flex flex-col items-center justify-center text-gray-500">
            <i data-lucide="layout-dashboard" class="w-16 h-16 mb-4 opacity-50"></i>
            <p>Select a session from the sidebar to view details</p>
        </div>

    </main>

    <script>
        // Init Icons
        lucide.createIcons();

        // Constants
        const POLLING_INTERVAL = 2000;
        let selectedSessionId = null;
        let pollTimer = null;

        // Elements
        const elList = document.getElementById('session-list');
        const elContainer = document.getElementById('report-container');
        const elEmpty = document.getElementById('empty-state');
        const elHeaderSub = document.getElementById('header-sub');
        const elConn = document.getElementById('connection-status');

        // State
        let sessionsMap = {};

        // Start
        setInterval(fetchSessions, POLLING_INTERVAL);
        fetchSessions();

        // Listen for selection
        function selectSession(sid) {
            selectedSessionId = sid;
            elEmpty.classList.add('hidden');
            elContainer.classList.remove('hidden');
            elHeaderSub.innerText = `ID: ${sid}`;

            // Highlight sidebar
            document.querySelectorAll('.session-item').forEach(el => el.classList.remove('bg-gray-700'));
            document.getElementById(`sess-${sid}`)?.classList.add('bg-gray-700');

            pollSession();
        }

        async function fetchSessions() {
            try {
                const res = await fetch('/agent/api/sessions');
                const list = await res.json();
                elConn.innerText = 'Connected';
                elConn.classList.add('text-green-400');

                // Diff update (simplified: just rebuild if length changed or simplistic check)
                // For smoother UI, we'd diff. For hackathon, rebuild list is acceptable if not annoying.
                // Or better: update content if ID exists.

                let html = '';
                const validIds = new Set(list.map(s => s.id));

                list.forEach(s => {
                    const activeClass = (selectedSessionId === s.id) ? 'bg-gray-700' : 'hover:bg-gray-700/50';
                    const riskColor = s.risk_level === 'HIGH' ? 'text-red-400' : (s.risk_level === 'MEDIUM' ? 'text-yellow-400' : 'text-green-400');

                    html += `
                        <div id="sess-${s.id}" onclick="selectSession('${s.id}')" class="p-3 mb-2 rounded cursor-pointer transition border border-gray-700/50 ${activeClass} session-item">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-bold text-gray-200">${s.phone}</span>
                                <span class="text-xs font-mono font-bold ${riskColor}">${s.risk_level}</span>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>PID: ...${s.account_id.slice(-4)}</span>
                                <span>${s.status}</span>
                            </div>
                        </div>
                    `;
                });

                if (html !== elList.innerHTML) {
                    elList.innerHTML = html;
                }

                // Auto-Select Logic:
                // 1. If we have sessions, and (nothing selected OR selected is dead) -> Select first
                if (list.length > 0) {
                    if (!selectedSessionId || !validIds.has(selectedSessionId)) {
                        console.log("Auto-selecting session:", list[0].id);
                        selectSession(list[0].id);
                    }
                }

                // If selected, update detail
                if (selectedSessionId) pollSession();

            } catch (e) {
                elConn.innerText = 'Offline';
                elConn.classList.remove('text-green-400');
            }
        }

        async function pollSession() {
            if (!selectedSessionId) return;

            try {
                const res = await fetch(`/agent/api/session/${selectedSessionId}`);
                if (res.status === 404) {
                    console.log("Session not found (404). Deselecting.");
                    selectedSessionId = null;
                    document.getElementById('view-report').classList.add('hidden');
                    document.getElementById('view-live').classList.add('hidden');
                    document.getElementById('empty-state').classList.remove('hidden');
                    return;
                }
                if (res.status !== 200) return;
                const data = await res.json();

                updateDashboard(data);
            } catch (e) {
                console.error(e);
            }
        }

        // Global Audio Vars
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        async function initAudio() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = uploadAudio;

                console.log("Microphone initialized.");
                document.getElementById('btn-mic').classList.remove('opacity-50', 'cursor-not-allowed');
                document.getElementById('btn-mic').classList.add('hover:bg-indigo-500');
                document.getElementById('btn-mic').disabled = false;
            } catch (err) {
                console.error("Mic Error:", err);
                alert("Microphone access denied. Please allow mic access.");
            }
        }

        function startRecording() {
            if (!mediaRecorder || mediaRecorder.state === 'recording') return;
            audioChunks = [];
            mediaRecorder.start();
            isRecording = true;

            // UI Visuals
            const btn = document.getElementById('btn-mic');
            btn.classList.add('bg-red-600', 'scale-105');
            btn.classList.remove('bg-indigo-600');
            btn.innerHTML = '<i data-lucide="mic" class="w-8 h-8 animate-pulse text-white"></i>';
            document.getElementById('mic-status').innerText = "Recording... Release to Send";
        }

        function stopRecording() {
            if (!mediaRecorder || mediaRecorder.state !== 'recording') return;
            mediaRecorder.stop();
            isRecording = false;

            // UI Visuals
            const btn = document.getElementById('btn-mic');
            btn.classList.remove('bg-red-600', 'scale-105');
            btn.classList.add('bg-indigo-600');
            btn.innerHTML = '<i data-lucide="mic" class="w-8 h-8 text-white"></i>';
            document.getElementById('mic-status').innerText = "Sending...";
        }

        async function uploadAudio() {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            const formData = new FormData();
            formData.append('file', audioBlob, 'agent_voice.wav');
            formData.append('session_id', selectedSessionId);

            try {
                const res = await fetch('/agent/speak', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if (data.status === 'sent') {
                    // Success feedback
                    document.getElementById('mic-status').innerText = "Sent! Waiting for response...";

                    // Add to transcript immediately for UX
                    const tBox = document.getElementById('transcript-box-live');
                    tBox.innerText += `\n[Agent]: (Audio Message Sent)\n`;
                    tBox.scrollTop = tBox.scrollHeight;
                } else {
                    document.getElementById('mic-status').innerText = "Error sending.";
                }
            } catch (e) {
                console.error(e);
                document.getElementById('mic-status').innerText = "Network Error";
            }
        }

        let isInterventionMode = false;

        async function resumeConversation() {
            // Switch to Live View
            isInterventionMode = true;

            document.getElementById('view-report').classList.add('hidden');
            document.getElementById('view-live').classList.remove('hidden');

            // Show Mic Controls
            document.getElementById('controls-area').classList.remove('hidden');

            // Init Mic
            await initAudio();
        }

        function updateDashboard(data) {
            const r = data.report || {};
            const risk = data.risk_breakdown || {};
            const breakdown = risk.breakdown || {};
            const isCompleted = data.state === "COMPLETED" || (data.report && data.report.fraud_risk_score !== undefined);

            const elViewLive = document.getElementById('view-live');
            const elViewReport = document.getElementById('view-report');

            // View Switching Logic
            if (isCompleted && !isInterventionMode) {
                // Show Report, Hide Live (Only if NOT interrupting)
                elViewLive.classList.add('hidden');
                elViewReport.classList.remove('hidden');

                // Update Report Elements
                // 1. Risk Score
                const score = Math.round(data.report?.fraud_risk_score || 0);
                document.getElementById('risk-score-val').innerText = score;

                const bar = document.getElementById('risk-bar');
                bar.style.width = `${score}%`;

                const badge = document.getElementById('risk-badge');
                const desc = document.getElementById('risk-desc');

                if (score >= 60) {
                    bar.className = 'h-full risk-gauge bg-red-500 shadow-[0_0_15px_rgba(239,68,68,0.5)]';
                    badge.className = 'px-3 py-1 rounded text-sm font-bold mb-2 ml-auto bg-red-500/20 text-red-400 border border-red-500/30';
                    badge.innerText = 'HIGH RISK';
                    desc.innerText = '⚠️ Immediate Intervention Required. Pattern matches known fraud.';
                } else if (score >= 40) {
                    bar.className = 'h-full risk-gauge bg-yellow-500';
                    badge.className = 'px-3 py-1 rounded text-sm font-bold mb-2 ml-auto bg-yellow-500/20 text-yellow-400 border border-yellow-500/30';
                    badge.innerText = 'MEDIUM RISK';
                    desc.innerText = '⚠️ Monitor closely. Some signals are flagged.';
                } else {
                    bar.className = 'h-full risk-gauge bg-green-500';
                    badge.className = 'px-3 py-1 rounded text-sm font-bold mb-2 ml-auto bg-green-500/20 text-green-400 border border-green-500/30';
                    badge.innerText = 'LOW RISK';
                    desc.innerText = '✅ Session appears normal. Verification proceeding.';
                }

                // 2. Signals
                const aiProb = (r.ai_audio_probability || 0) * 100;
                const elAi = document.getElementById('sig-ai');
                elAi.innerHTML = `${aiProb.toFixed(0)}% <span class="${aiProb > 50 ? 'text-red-400' : 'text-green-400'}">${aiProb > 50 ? '(FAKE)' : '(HUMAN)'}</span>`;

                const vmScore = (r.voice_match_score || 0) * 100;
                const elMatch = document.getElementById('sig-match');
                if (data.report?.is_first_time_caller) {
                    elMatch.innerHTML = `NEW <span class="text-blue-400">(First Time)</span>`;
                } else {
                    elMatch.innerHTML = `${vmScore.toFixed(0)}% <span class="${vmScore < 70 ? 'text-red-400' : 'text-green-400'}">${vmScore < 70 ? '(MISMATCH)' : '(MATCH)'}</span>`;
                }

                // Identity
                const identOK = r.personal_details_verified || (r.personal_details?.name && !breakdown.data_score);
                const elIdent = document.getElementById('sig-identity');
                elIdent.innerHTML = `<span class="${identOK ? 'text-green-400' : 'text-yellow-500'}">${identOK ? 'VERIFIED' : 'PENDING'}</span>`;

                // Related Accounts (Graph Access)
                const elRelated = document.getElementById('related-accounts-list');
                if (r.related_accounts && r.related_accounts.length > 0) {
                    let listHtml = r.related_accounts.map(acc =>
                        `<div class="flex items-center gap-2">
                            <i data-lucide="link" class="w-3 h-3 text-indigo-400"></i>
                            <span>${acc}</span>
                         </div>`
                    ).join('');
                    elRelated.innerHTML = listHtml;
                    lucide.createIcons();
                } else {
                    elRelated.innerHTML = '<p class="italic text-gray-600">None found (Standalone Node).</p>';
                }

                // Latency
                let latVal = 0;
                if (data.latency_risks && data.latency_risks.length > 0) {
                    latVal = data.latency_risks[0].hesitation;
                }
                document.getElementById('sig-latency').innerText = `${latVal.toFixed(2)}s`;

                // Memory
                const signals = risk.signals || {};
                document.getElementById('mem-name').innerHTML = `${((signals.name_stability || 1) * 100).toFixed(0)}%`;
                document.getElementById('mem-dob').innerHTML = `${((signals.dob_stability || 1) * 100).toFixed(0)}%`;
                document.getElementById('mem-trust').innerHTML = (signals.trust_trend || 'Neutral').toUpperCase();

                // Transcript Preview in Report
                const txt = data.transcript || "Conversation ended.";
                const tBox = document.getElementById('transcript-box-report');
                tBox.innerText = txt;
                tBox.scrollTop = tBox.scrollHeight;

            } else {
                // Show Live, Hide Report
                elViewLive.classList.remove('hidden');
                elViewReport.classList.add('hidden');

                // Update Live Transcript
                const txt = data.transcript || "";
                const tBox = document.getElementById('transcript-box-live');
                // Only update if changed to avoid jumpiness? (optional, straightforward to just update)
                tBox.innerText = txt || "Waiting for audio...";
                tBox.scrollTop = tBox.scrollHeight;
            }
        }

    </script>
</body>

</html>